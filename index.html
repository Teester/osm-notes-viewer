<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<style>
		body {
		  font: 15px Helvetica, arial, sans-serif;
		}

		table {
			border-collapse: collapse;
			width: 100%;
			background-color: #f2f2f2;
		}

		td, th {
			border-top: 1px solid #ddd;
			border-left: 1px solid #ddd;
			border-right: 1px solid #ddd;
			padding: 8px;
		}

		tr:hover, .selected {background-color: #ddd;}

		.toplevel {
			border: 0px;
		}

		.comment tr {
			background-color: #e2e2e2;
			border: 0px;
		}

		.subcomment {
			background-color: #f2f2f2;
			padding-left: 50px;
			font-size: 14px;
		}

		.user {
			font-size: 15px;
		}

		th {
			padding-top: 12px;
			padding-bottom: 12px;
			text-align: left;
			background-color: #4CAF50;
			color: white;
		}

		#mapid { height:400px; }

	</style>
	<title>OSM Notes in Ireland</title>
</head>

<body>
	<h2 id="title">OSM Notes</h2>
	<div id="mapid"></div>
	<p id="notestable"/>

	<script>
		function getURLParameter(name) {
		  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
		}

		var bbox = getURLParameter('bbox') || "-11.0133787,51.222,-5.6582362,55.636";
		var api_url = 'https://api.openstreetmap.org/api/0.6/notes.json?closed=0&bbox=' + bbox
		var fields = bbox.split(',');

		var minlong = fields[0] * 1;
		var minlat = fields[1] * 1;
		var maxlong = fields[2] * 1;
		var maxlat = fields[3] * 1;

		var mymap = L.map('mapid');
		var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		});
		var min = new L.latLng(minlat, minlong);
		var max = new L.latLng(maxlat, maxlong);
		var bounds = new L.LatLngBounds([min, max]);
		mymap.fitBounds(bounds);

		OpenStreetMap_Mapnik.addTo(mymap);
		var rectangle= L.rectangle([min,max],{fillopacity:0});
		//var rectangle = L.rectangle([[51.49, -0.1], [51.48, -0.06]]);
		//rectangle.editing.enable();
		mymap.addLayer(rectangle);

		readTextFile(api_url, function (text) {
			var data = JSON.parse(text);
			var txt = "";
			var pattern = /(\d{4})\-(\d{2})\-(\d{2})\ (\d{2}):(\d{2}):(\d{2})\ UTC/;
			txt += "<table id='notestable'><thead><th>Note ID</th><th>Time Opened</th><th>Note text</th><th>Author</th><th>No of Comments</th></thead><tbody>";
			var coordinates;
			for (var x in data.features) {
				coordinates=data.features[x].geometry.coordinates;
				txt += "<tr class='toplevel' id ='" + data.features[x].properties.id + "'><td><a href=http://www.openstreetmap.org/note/" + data.features[x].properties.id + ">" + data.features[x].properties.id + "</a></td>";
				var st = data.features[x].properties.comments[0].date; 
				var dt = new Date(st.replace(pattern,'$1-$2-$3 $4:$5:$6'));       
				txt += "<td>" + dt.toLocaleDateString() + "</td>";
				for (var comment in data.features[x].properties.comments) {
				  if (comment === "0") {
					txt += "<td class='comment'>" + data.features[x].properties.comments[0].html + "</td>";
					if (data.features[x].properties.comments[0].user) {
					  txt += "<td class='user'><a href=" + data.features[x].properties.comments[0].user_url + ">" + data.features[x].properties.comments[0].user + "</a></td>";
					} else {
					  txt += "<td class='user'>anonymous</td>";
					}
					txt += "<td>" + (Object.keys(data.features[x].properties.comments).length -1) + "</td>";
				  } else {
					var st2 = data.features[x].properties.comments[comment].date; 
					var dt2 = new Date(st2.replace(pattern,'$1-$2-$3 $4:$5:$6'));       
					txt += "</tr><tr class='subcomment' id ='" + data.features[x].properties.id + "'><td>⤷</td><td>" + dt2.toLocaleDateString() + "</td><td>" + data.features[x].properties.comments[comment].html + "</td>";
					if (data.features[x].properties.comments[comment].user) {
					  txt += "<td class='user'><a href=" + data.features[x].properties.comments[comment].user_url + ">" + data.features[x].properties.comments[comment].user + "</a></td><td/></tr><tr>";
					} else {
					  txt += "<td>anonymous</td>";
					}
				  }
				}
				txt += "</tr>";
				var latLng = new L.latLng([coordinates[1], coordinates[0]]);
				var marker = L.marker(latLng).addTo(mymap);
				marker.bindPopup("Note " + data.features[x].properties.id + "<br/>" + data.features[x].properties.comments[0].html);
			}
			txt += "</tbody></table>";
			document.getElementById("notestable").innerHTML = txt;
		});

		function readTextFile(file, callback) {
			var rawFile = new XMLHttpRequest();
			rawFile.overrideMimeType("application/json");
			rawFile.open("GET", file, true);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4 && rawFile.status == "200") {
					callback(rawFile.responseText);
				}
			};
			rawFile.send(null);
		}
	</script>
</body>
</html>
